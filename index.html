<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 é˜ªäº¬ä¹‹æ—…</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome & Google Fonts -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #FDFCF8; /* å½±ç‰‡ä¸­çš„ç±³è‰²èƒŒæ™¯ */
            -webkit-tap-highlight-color: transparent;
        }
        
        /* éš±è—æ»¾å‹•æ¢ä½†ä¿æŒåŠŸèƒ½ */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* æ¨¡æ“¬ iOS åº•éƒ¨å®‰å…¨å€ */
        .safe-area-bottom {
            padding-bottom: env(safe-area-inset-bottom, 20px);
        }

        /* å‹•ç•«æ•ˆæœ */
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* è‡ªå®šç¾©é¡è‰² */
        .bg-kyoto-gold { background-color: #D4AF37; }
        .text-kyoto-gold { color: #D4AF37; }
        .border-kyoto-gold { border-color: #D4AF37; }
        
        /* AI é–ƒçˆæ•ˆæœ */
        @keyframes sparkle {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .animate-sparkle {
            animation: sparkle 2s infinite;
        }
    </style>
</head>
<body class="bg-[#FDFCF8] text-gray-800 h-screen overflow-hidden">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // ---------------------------------------------------------
        // ğŸ‰ æ‚¨çš„ Google Gemini API Key å·²æˆåŠŸåµŒå…¥ï¼ğŸ‰
        // ---------------------------------------------------------
        const apiKey = "AIzaSyDOVudJOKxWfLPN-N1pxolabpS5Rw_v9l4"; 
        // ---------------------------------------------------------
        
        // Helper function to call Gemini
        async function callGemini(prompt, systemInstruction = "") {
            if (!apiKey) {
                alert("è«‹å…ˆåœ¨ç¨‹å¼ç¢¼ä¸­å¡«å…¥ API Key æ‰èƒ½ä½¿ç”¨ AI åŠŸèƒ½å–”ï¼");
                throw new Error("No API Key");
            }

            // ç¢ºä¿é‡‘é‘°å·²åµŒå…¥å¾Œï¼ŒåŸ·è¡Œ API å‘¼å«
            try {
                // ç‚ºäº†è™•ç†é‡è¤‡å‘¼å«å•é¡Œï¼ŒåŠ å…¥ç°¡å–®çš„æŒ‡æ•¸é€€é¿é‡è©¦æ©Ÿåˆ¶
                const maxRetries = 3;
                let lastError = null;
                for (let i = 0; i < maxRetries; i++) {
                    try {
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{ parts: [{ text: prompt }] }],
                                systemInstruction: { parts: [{ text: systemInstruction }] },
                                generationConfig: {
                                    responseMimeType: "application/json"
                                }
                            })
                        });
                        
                        const data = await response.json();
                        
                        if (data.error) {
                            throw new Error(data.error.message);
                        }
                        
                        // æˆåŠŸè§£æ JSON
                        return JSON.parse(data.candidates[0].content.parts[0].text);
                        
                    } catch (error) {
                        lastError = error;
                        // å¦‚æœæ˜¯ç¶²è·¯éŒ¯èª¤æˆ–è§£æéŒ¯èª¤ï¼Œç­‰å¾…ä¸€æ®µæ™‚é–“å¾Œé‡è©¦
                        if (i < maxRetries - 1) {
                            await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
                        }
                    }
                }
                throw lastError; // æ‰€æœ‰é‡è©¦éƒ½å¤±æ•—
            } catch (error) {
                console.error("Gemini API Error:", error);
                
                // ç‚ºäº†ä¸è®“ç”¨æˆ¶å¡ä½ï¼Œå³ä½¿å¤±æ•—ä¹Ÿè¿”å›ä¸€å€‹é è¨­å€¼
                if (systemInstruction.includes("financial advisor")) {
                    return { advice: "API è«‹æ±‚å¤±æ•—ï¼ŒAI æ­£åœ¨å–æŠ¹èŒ¶ä¼‘æ¯ä¸­...ğŸµ" };
                } else {
                    return [{ name: "AI æ¨è–¦å¤±æ•—", category: "æ™¯é»", note: "è«‹æª¢æŸ¥ç¶²è·¯æˆ– API Key é™åˆ¶" }];
                }
            }
        }
        
        // --- åœ–ç¤ºçµ„ä»¶ ---
        const Icons = {
            Hotel: () => <i className="fas fa-bed"></i>,
            Spot: () => <i className="fas fa-camera"></i>,
            Food: () => <i className="fas fa-utensils"></i>,
            Shopping: () => <i className="fas fa-shopping-bag"></i>,
            Transport: () => <i className="fas fa-train"></i>,
            Walk: () => <i className="fas fa-walking"></i>,
            Plus: () => <i className="fas fa-plus"></i>,
            Map: () => <i className="fas fa-map-marked-alt"></i>,
            List: () => <i className="fas fa-list-ul"></i>,
            Wallet: () => <i className="fas fa-wallet"></i>,
            Book: () => <i className="fas fa-book-open"></i>,
            Bolt: () => <i className="fas fa-bolt"></i>,
            Check: () => <i className="fas fa-check"></i>,
            Trash: () => <i className="fas fa-trash-alt"></i>,
            Magic: () => <i className="fas fa-wand-magic-sparkles"></i>,
            Brain: () => <i className="fas fa-brain"></i>,
        };

        // --- æ¨¡æ“¬è³‡æ–™ ---
        const INITIAL_SPOTS = [
            { id: 1, day: 1, name: 'KOKO HOTEL äº¬éƒ½', category: 'ä½å®¿', time: '09:00', icon: 'Hotel', note: 'èµ·é»' },
            { id: 2, day: 1, name: 'æ¸…æ°´å¯º', category: 'æ™¯é»', time: '10:00', icon: 'Spot', note: 'äº¬éƒ½ãƒ»æ±å±±' },
            { id: 3, day: 1, name: '@cosme OSAKAæ——è‰¦åº—', category: 'è³¼ç‰©', time: '11:00', icon: 'Shopping', note: 'å¤§é˜ªåºœå¤§é˜ªå¸‚' },
            { id: 4, day: 1, name: 'å¥§ä¸¹ æ¹¯è±†è…', category: 'ç¾é£Ÿ', time: '12:30', icon: 'Food', note: 'äº¬éƒ½ãƒ»æ¸…æ°´' },
            { id: 5, day: 1, name: 'KOKO HOTEL äº¬éƒ½', category: 'ä½å®¿', time: '18:00', icon: 'Hotel', note: 'è¿”å›' },
        ];

        const INITIAL_EXPENSES = [
            { id: 1, name: 'ç« é­šç‡’', amount: 800, type: 'food' },
            { id: 2, name: 'æ¸…æ°´å¯ºé–€ç¥¨', amount: 400, type: 'ticket' },
        ];

        // --- ä¸»æ‡‰ç”¨ç¨‹å¼ ---
        function App() {
            const [activeTab, setActiveTab] = useState('itinerary');
            const [spots, setSpots] = useState(INITIAL_SPOTS);
            const [expenses, setExpenses] = useState(INITIAL_EXPENSES);
            const [activeDay, setActiveDay] = useState(1);
            const [showAddModal, setShowAddModal] = useState(false);
            const [isOptimizing, setIsOptimizing] = useState(false);

            // å–å¾—ç•¶å‰å¤©æ•¸çš„è¡Œç¨‹
            const currentDaySpots = spots.filter(s => s.day === activeDay);
            const totalBudget = 100000;
            const totalSpent = expenses.reduce((acc, cur) => acc + cur.amount, 0);

            // --- åŠŸèƒ½é‚è¼¯ ---

            // æ¨¡æ“¬ AI é †è·¯ (å‰ç«¯æ¨¡æ“¬ï¼Œè‹¥æœ‰ API Key å¯æ”¹ç‚ºçœŸå¯¦å‘¼å«)
            const handleOptimize = () => {
                setIsOptimizing(true);
                setTimeout(() => {
                    const hotelStart = currentDaySpots.find(s => s.icon === 'Hotel' && s.time < '12:00');
                    const hotelEnd = currentDaySpots.find(s => s.icon === 'Hotel' && s.time > '12:00');
                    const others = currentDaySpots.filter(s => s.icon !== 'Hotel');
                    
                    // ç°¡å–®çš„éš¨æ©Ÿæ´—ç‰Œæ¨¡æ“¬ "AI è¨ˆç®—"
                    const shuffled = [...others].sort(() => Math.random() - 0.5);
                    
                    // é‡æ–°åˆ†é…æ™‚é–“
                    let currentTime = 9; // å¾ 9 é»é–‹å§‹
                    const newDaySpots = [];
                    
                    if (hotelStart) newDaySpots.push(hotelStart);
                    
                    shuffled.forEach((spot, index) => {
                        currentTime += 1.5; // å‡è¨­æ¯å€‹é»ç© 1.5 å°æ™‚
                        const hour = Math.floor(currentTime);
                        const minute = (currentTime - hour) * 60;
                        const timeStr = `${hour.toString().padStart(2, '0')}:${minute === 0 ? '00' : '30'}`;
                        newDaySpots.push({ ...spot, time: timeStr });
                    });

                    if (hotelEnd) {
                        newDaySpots.push({ ...hotelEnd, time: '18:00' });
                    }

                    // æ›´æ–° State
                    const otherDaysSpots = spots.filter(s => s.day !== activeDay);
                    setSpots([...otherDaysSpots, ...newDaySpots].sort((a, b) => a.time.localeCompare(b.time)));
                    
                    setIsOptimizing(false);
                    alert("âœ¨ AI å·²ç‚ºæ‚¨å„ªåŒ–æœ€ä½³è·¯å¾‘ï¼");
                }, 1500);
            };

            // æ–°å¢åœ°é»
            const handleAddSpot = (newSpot) => {
                const spot = {
                    ...newSpot,
                    id: Date.now(),
                    day: activeDay,
                };
                // æ’å…¥ä¸¦æ’åº
                const newSpots = [...spots, spot].sort((a, b) => a.time.localeCompare(b.time));
                setSpots(newSpots);
                setShowAddModal(false);
            };

            // æ–°å¢è¨˜å¸³
            const handleAddExpense = (newExpense) => {
                setExpenses([...expenses, { ...newExpense, id: Date.now() }]);
            };

            return (
                <div className="flex flex-col h-full max-w-md mx-auto bg-[#FDFCF8] shadow-2xl overflow-hidden relative border-x border-gray-100">
                    
                    {/* é ‚éƒ¨èƒŒæ™¯åœ– (è£é£¾) */}
                    <div className="h-48 w-full bg-gray-800 relative shrink-0">
                        <img src="https://images.unsplash.com/photo-1493976040374-85c8e12f0c0e?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80" alt="Kyoto" className="w-full h-full object-cover opacity-60" />
                        <div className="absolute bottom-4 left-4 text-white">
                            <div className="text-2xl font-bold tracking-widest">2026 é˜ªäº¬ä¹‹æ—…</div>
                            <div className="text-xs opacity-80 mt-1">1/17 - 1/22</div>
                        </div>
                        <div className="absolute top-4 right-4 text-white/80">
                            <i className="fas fa-cog"></i>
                        </div>
                    </div>

                    {/* ä¸»è¦å…§å®¹å€ */}
                    <div className="flex-1 overflow-y-auto no-scrollbar relative bg-[#FDFCF8] -mt-4 rounded-t-3xl z-10">
                        
                        {/* è¡Œç¨‹åˆ†é å…§å®¹ */}
                        {activeTab === 'itinerary' && (
                            <ItineraryView 
                                activeDay={activeDay} 
                                setActiveDay={setActiveDay} 
                                spots={currentDaySpots} 
                                onOptimize={handleOptimize}
                                isOptimizing={isOptimizing}
                            />
                        )}

                        {/* è¨˜å¸³åˆ†é å…§å®¹ */}
                        {activeTab === 'wallet' && (
                            <WalletView 
                                totalBudget={totalBudget} 
                                totalSpent={totalSpent} 
                                expenses={expenses}
                                onAddExpense={handleAddExpense}
                            />
                        )}

                        {/* æ‰‹å†Šåˆ†é å…§å®¹ */}
                        {activeTab === 'guide' && <GuideView />}
                         
                         <!-- åœ°åœ–åˆ†é  (éœæ…‹æ¨¡æ“¬) -->
                        {activeTab === 'map' && (
                             <div className="p-6 text-center text-gray-400 mt-20">
                                <div className="text-6xl mb-4 text-gray-200"><Icons.Map /></div>
                                <p>åœ°åœ–æ¨¡å¼è¼‰å…¥ä¸­...</p>
                                <p className="text-xs mt-2">(æ­¤ç‚ºæ¨¡æ“¬ä»‹é¢ï¼Œç„¡çœŸå¯¦ GPS åŠŸèƒ½)</p>
                            </div>
                        )}
                        
                        <!-- åº•éƒ¨ç•™ç™½çµ¦ Fab å’Œ TabBar -->
                        <div className="h-24"></div>
                    </div>

                    <!-- æµ®å‹•æŒ‰éˆ• (FAB) - åªåœ¨è¡Œç¨‹å’ŒéŒ¢åŒ…é é¢é¡¯ç¤º -->
                    {(activeTab === 'itinerary' || activeTab === 'wallet') && (
                        <button 
                            onClick={() => setShowAddModal(true)}
                            className="absolute bottom-24 left-1/2 transform -translate-x-1/2 bg-kyoto-gold text-white px-6 py-3 rounded-full shadow-lg flex items-center gap-2 hover:bg-[#c49f30] transition-colors z-20 font-bold"
                        >
                            <Icons.Plus /> {activeTab === 'itinerary' ? 'æ–°å¢åœ°é»' : 'è¨˜ä¸Šä¸€ç­†'}
                        </button>
                    )}

                    <!-- åº•éƒ¨å°èˆªåˆ— -->
                    <div className="h-20 bg-white border-t border-gray-100 flex justify-around items-center px-2 pb-2 safe-area-bottom z-30 shrink-0">
                        <TabButton icon="List" label="è¡Œç¨‹" active={activeTab === 'itinerary'} onClick={() => setActiveTab('itinerary')} />
                        <TabButton icon="Map" label="åœ°åœ–" active={activeTab === 'map'} onClick={() => setActiveTab('map')} />
                        <TabButton icon="Wallet" label="éŒ¢åŒ…" active={activeTab === 'wallet'} onClick={() => setActiveTab('wallet')} />
                        <TabButton icon="Book" label="æ‰‹å†Š" active={activeTab === 'guide'} onClick={() => setActiveTab('guide')} />
                    </div>

                    <!-- å½ˆå‡ºè¦–çª—ï¼šæ–°å¢åœ°é»/è¨˜å¸³ -->
                    {showAddModal && (
                        <AddModal 
                            type={activeTab} 
                            onClose={() => setShowAddModal(false)} 
                            onConfirm={activeTab === 'itinerary' ? handleAddSpot : handleAddExpense}
                        />
                    )}
                    
                    <!-- Loading Overlay -->
                    {isOptimizing && (
                        <div className="absolute inset-0 bg-black/50 z-50 flex items-center justify-center backdrop-blur-sm">
                            <div className="bg-white p-6 rounded-2xl flex flex-col items-center animate-bounce">
                                <div className="text-kyoto-gold text-4xl mb-2"><i className="fas fa-magic"></i></div>
                                <div className="font-bold text-gray-700">AI æ­£åœ¨è¨ˆç®—æœ€ä½³è·¯å¾‘...</div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // --- å­çµ„ä»¶ï¼šè¡Œç¨‹é é¢ ---
        function ItineraryView({ activeDay, setActiveDay, spots, onOptimize, isOptimizing }) {
            const days = [1, 2, 3, 4, 5];
            
            return (
                <div className="fade-in">
                    <!-- å¤©æ•¸é¸æ“‡å™¨ -->
                    <div className="flex gap-3 overflow-x-auto p-4 no-scrollbar items-center sticky top-0 bg-[#FDFCF8] z-10">
                        {days.map(d => (
                            <button 
                                key={d}
                                onClick={() => setActiveDay(d)}
                                className={`w-14 h-14 rounded-full flex flex-col items-center justify-center shrink-0 border-2 transition-all ${
                                    activeDay === d 
                                    ? 'bg-kyoto-gold border-kyoto-gold text-white shadow-lg scale-110' 
                                    : 'bg-white border-gray-200 text-gray-400'
                                }`}
                            >
                                <span className="text-[10px] font-bold">DAY</span>
                                <span className="text-xl font-bold leading-none">{d}</span>
                            </button>
                        ))}
                        <div className="w-4"></div>
                    </div>

                    <!-- AI æŒ‰éˆ•èˆ‡æ¨™é¡Œ -->
                    <div className="flex justify-between items-center px-6 mb-4">
                        <h2 className="text-2xl font-serif font-bold text-gray-800">Day {activeDay}</h2>
                        <button 
                            onClick={onOptimize}
                            disabled={isOptimizing}
                            className="bg-white border border-gray-200 shadow-sm px-3 py-1.5 rounded-full text-xs font-bold flex items-center gap-1 hover:bg-gray-50 transition-colors"
                        >
                            <span className="text-kyoto-gold"><Icons.Bolt /></span> AI é †è·¯
                        </button>
                    </div>

                    <!-- æ™‚é–“è»¸åˆ—è¡¨ -->
                    <div className="px-5">
                        {spots.map((spot, index) => (
                            <div key={spot.id} className="flex group mb-2">
                                <!-- å·¦å´æ™‚é–“è»¸ -->
                                <div className="flex flex-col items-center mr-4 w-12 pt-1">
                                    <div className="text-xs font-bold text-gray-400 mb-1">{spot.time}</div>
                                    <div className={`w-3 h-3 rounded-full border-2 border-white shadow-sm z-10 ${
                                        spot.category === 'ä½å®¿' ? 'bg-gray-400' : 'bg-kyoto-gold'
                                    }`}></div>
                                    {index !== spots.length - 1 && (
                                        <div className="w-0.5 bg-gray-200 flex-1 my-1 opacity-50"></div>
                                    )}
                                </div>
                                
                                <!-- å³å´å¡ç‰‡ -->
                                <div className="flex-1 pb-6">
                                    <div className="bg-white p-4 rounded-xl shadow-[0_4px_20px_rgba(0,0,0,0.03)] border border-gray-50 hover:shadow-md transition-shadow">
                                        <div className="flex justify-between items-start">
                                            <div>
                                                <span className="bg-gray-100 text-[10px] text-gray-500 px-1.5 py-0.5 rounded mb-2 inline-block">
                                                    {spot.category}
                                                </span>
                                                <h3 className="font-bold text-lg text-gray-800 leading-tight mb-1">{spot.name}</h3>
                                                <p className="text-xs text-gray-400 flex items-center gap-1">
                                                    <i className="fas fa-map-marker-alt text-[10px]"></i> {spot.note || 'å°šæœªè¨­å®šå‚™è¨»'}
                                                </p>
                                            </div>
                                            <div className="text-gray-300">
                                                <button className="p-2 hover:text-red-400 transition-colors"><Icons.Trash /></button>
                                            </div>
                                        </div>
                                        
                                        <!-- äº¤é€šæ¨¡æ“¬ -->
                                        {index !== spots.length - 1 && (
                                            <div className="mt-4 pt-3 border-t border-dashed border-gray-100 flex items-center text-xs text-gray-400 gap-2">
                                                <Icons.Transport />
                                                <span>äº¬é˜ªæœ¬ç·š ç´„ 20 åˆ†</span>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        // --- å­çµ„ä»¶ï¼šéŒ¢åŒ…é é¢ ---
        function WalletView({ totalBudget, totalSpent, expenses, onAddExpense }) {
            const [advice, setAdvice] = useState('');
            const [loadingAdvice, setLoadingAdvice] = useState(false);
            
            const balance = totalBudget - totalSpent;
            const percentage = Math.min(100, (totalSpent / totalBudget) * 100);

            // Gemini: åˆ†ææ¶ˆè²»
            const handleAnalyze = async () => {
                if (expenses.length === 0) {
                    setAdvice("é‚„æ²’èŠ±éŒ¢æ€éº¼åˆ†æå•¦ï¼è¶•å¿«å»è²·è²·è²·ï¼ğŸ˜‚");
                    return;
                }
                
                setLoadingAdvice(true);
                try {
                    const expenseList = expenses.map(e => `${e.name}: ${e.amount}æ—¥åœ“`).join(", ");
                    const prompt = `åˆ†æé€™äº›æ—…éŠæ”¯å‡º: [${expenseList}]ã€‚è«‹ç”¨å¹½é»˜ã€åƒæœ‹å‹ä¸€æ¨£çš„èªæ°£ï¼Œç°¡çŸ­(30å­—å…§)è©•è«–æˆ‘çš„æ¶ˆè²»ç¿’æ…£ã€‚è«‹å›å‚³ JSON æ ¼å¼: { "advice": "ä½ çš„è©•è«–" }`;
                    
                    const result = await callGemini(prompt, "You are a funny financial advisor.");
                    setAdvice(result.advice);
                } catch (e) {
                    setAdvice("AI ç®—éŒ¢ç®—åˆ°é ­æšˆäº†...è«‹æª¢æŸ¥ API Key æˆ–ç¨å¾Œå†è©¦ ğŸ˜µ");
                    console.error(e);
                } finally {
                    setLoadingAdvice(false);
                }
            };

            return (
                <div className="p-6 fade-in">
                    <!-- é ç®—å¡ç‰‡ -->
                    <div className="bg-gradient-to-br from-gray-800 to-gray-900 rounded-2xl p-6 text-white shadow-xl mb-8 relative overflow-hidden">
                        
                        <!-- AI é¡§å•æŒ‰éˆ• -->
                        <button 
                            onClick={handleAnalyze}
                            disabled={loadingAdvice}
                            className="absolute top-4 right-4 bg-white/20 hover:bg-white/30 backdrop-blur-sm px-3 py-1 rounded-full text-xs flex items-center gap-1 transition-all z-20"
                        >
                            {loadingAdvice ? <i className="fas fa-spinner fa-spin"></i> : <Icons.Magic />} 
                            {loadingAdvice ? 'åˆ†æä¸­...' : 'åˆ†æ'}
                        </button>

                        <div className="absolute top-0 right-0 w-32 h-32 bg-white opacity-5 rounded-full -mr-10 -mt-10"></div>
                        <div className="flex justify-between items-center mb-6">
                            <div>
                                <div className="text-xs opacity-60 mb-1">é è¨ˆèŠ±è²»</div>
                                <div className="text-xl font-bold">Â¥{totalBudget.toLocaleString()}</div>
                            </div>
                            <div className="text-right">
                                <div className="text-xs opacity-60 mb-1">å·²è³¼è²·</div>
                                <div className="text-xl font-bold text-kyoto-gold">Â¥{totalSpent.toLocaleString()}</div>
                            </div>
                        </div>
                        
                        <div className="bg-white/10 rounded-full h-1.5 w-full mb-2">
                            <div className="bg-kyoto-gold h-1.5 rounded-full transition-all duration-1000" style={{width: `${percentage}%`}}></div>
                        </div>
                        <div className="flex justify-between text-xs opacity-50">
                            <span>ç¾é‡‘æ®˜é«˜</span>
                            <span>Â¥{balance.toLocaleString()} / Â¥{totalBudget.toLocaleString()}</span>
                        </div>
                    </div>

                    <!-- AI å»ºè­°æ°£æ³¡ -->
                    {advice && (
                        <div className="mb-6 bg-yellow-50 border border-yellow-200 p-4 rounded-xl flex gap-3 items-start animate-[slideUp_0.3s_ease-out]">
                            <div className="text-kyoto-gold mt-1"><Icons.Brain /></div>
                            <div>
                                <div className="text-xs font-bold text-gray-400 mb-1">AI éŒ¢åŒ…é¡§å•</div>
                                <div className="text-gray-800 text-sm leading-relaxed">{advice}</div>
                            </div>
                            <button onClick={() => setAdvice('')} className="text-gray-400 ml-auto"><i className="fas fa-times"></i></button>
                        </div>
                    )}

                    <!-- æ”¯å‡ºåˆ—è¡¨ -->
                    <h3 className="font-bold text-gray-800 mb-4 flex items-center gap-2">
                        <i className="fas fa-receipt text-kyoto-gold"></i> æ”¯å‡ºæ˜ç´°
                    </h3>
                    <div className="space-y-3 pb-20">
                        {expenses.length === 0 ? (
                            <div className="text-center text-gray-400 py-10">å°šæœªæœ‰ä»»ä½•æ”¯å‡º</div>
                        ) : (
                            expenses.map(item => (
                                <div key={item.id} className="bg-white p-4 rounded-xl shadow-sm border border-gray-50 flex justify-between items-center">
                                    <div className="flex items-center gap-3">
                                        <div className="w-10 h-10 rounded-full bg-gray-50 flex items-center justify-center text-gray-400">
                                            {item.type === 'food' ? <Icons.Food /> : <Icons.Shopping />}
                                        </div>
                                        <div>
                                            <div className="font-bold text-gray-800">{item.name}</div>
                                            <div className="text-xs text-gray-400">æˆ‘ä»˜ â€¢ å€‹äºº</div>
                                        </div>
                                    </div>
                                    <div className="font-bold font-mono text-gray-700">-Â¥{item.amount}</div>
                                </div>
                            ))
                        )}
                    </div>
                </div>
            );
        }

        // --- å­çµ„ä»¶ï¼šæ‰‹å†Šé é¢ ---
        function GuideView() {
            const [checklist, setChecklist] = useState([
                { id: 1, text: 'è­·ç…§ (æ•ˆæœŸ6å€‹æœˆ+)', checked: false, important: true },
                { id: 2, text: 'VJW å¡«å¯«', checked: true, important: true },
                { id: 3, text: 'æ—…éŠå¹³éšª/ä¸ä¾¿éšª', checked: false, important: true },
                { id: 4, text: 'eSIM / æ¼«éŠ', checked: false, important: false },
                { id: 5, text: 'æ›æ—¥å¹£', checked: false, important: false },
            ]);

            const toggleCheck = (id) => {
                setChecklist(checklist.map(item => 
                    item.id === id ? { ...item, checked: !item.checked } : item
                ));
            };

            return (
                <div className="p-6 fade-in">
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-2xl font-bold">æ—…ã®ã—ãŠã‚Š</h2>
                        <button className="text-sm bg-gray-100 px-3 py-1 rounded-full text-gray-600">
                            <i className="fas fa-pen text-xs mr-1"></i> ç·¨è¼¯
                        </button>
                    </div>

                    <div className="mb-8">
                        <h3 className="text-sm font-bold text-gray-500 mb-3 flex items-center gap-2">
                            <i className="far fa-check-square"></i> æº–å‚™æ¸…å–®
                        </h3>
                        <div className="bg-white rounded-2xl shadow-sm overflow-hidden">
                            {checklist.map(item => (
                                <div 
                                    key={item.id} 
                                    onClick={() => toggleCheck(item.id)}
                                    className="p-4 border-b border-gray-50 last:border-0 flex items-center justify-between active:bg-gray-50 cursor-pointer"
                                >
                                    <div className="flex items-center gap-3">
                                        <div className={`w-5 h-5 rounded border flex items-center justify-center transition-colors ${
                                            item.checked ? 'bg-kyoto-gold border-kyoto-gold text-white' : 'border-gray-300'
                                        }`}>
                                            {item.checked && <i className="fas fa-check text-xs"></i>}
                                        </div>
                                        <span className={`${item.checked ? 'text-gray-400 line-through' : 'text-gray-700'}`}>
                                            {item.text}
                                        </span>
                                    </div>
                                    {item.important && (
                                        <span className="text-[10px] text-red-400 bg-red-50 px-2 py-0.5 rounded">é‡è¦</span>
                                    )}
                                </div>
                            ))}
                        </div>
                    </div>

                    <div>
                        <h3 className="text-sm font-bold text-gray-500 mb-3 flex items-center gap-2">
                            <i className="fas fa-plane-departure"></i> èˆªç­
                        </h3>
                        <div className="bg-white p-4 rounded-xl shadow-sm mb-3">
                            <div className="text-xs text-gray-400 mb-1">å»ç¨‹ 1/17</div>
                            <div className="flex justify-between items-end">
                                <div className="text-xl font-bold">10:00 -> 13:30</div>
                                <div className="text-xs text-gray-400">JX821</div>
                            </div>
                            <div className="text-xs text-gray-500 mt-1"><i className="fas fa-map-marker-alt mr-1"></i> æ¡ƒåœ’ T1</div>
                        </div>
                        <div className="bg-white p-4 rounded-xl shadow-sm">
                            <div className="text-xs text-gray-400 mb-1">å›ç¨‹ 1/22</div>
                            <div className="flex justify-between items-end">
                                <div className="text-xl font-bold">15:00 -> 17:10</div>
                                <div className="text-xs text-gray-400">JX822</div>
                            </div>
                            <div className="text-xs text-gray-500 mt-1"><i className="fas fa-map-marker-alt mr-1"></i> é—œç©º T1</div>
                        </div>
                    </div>
                </div>
            );
        }

        // --- å½ˆå‡ºè¦–çª—çµ„ä»¶ ---
        function AddModal({ type, onClose, onConfirm }) {
            const [name, setName] = useState('');
            const [amount, setAmount] = useState('');
            const [category, setCategory] = useState('æ™¯é»');
            const [time, setTime] = useState('12:00');
            const [note, setNote] = useState('è‡ªè¨‚åœ°é»');
            
            // AI ç›¸é—œç‹€æ…‹
            const [showAiSearch, setShowAiSearch] = useState(false);
            const [aiQuery, setAiQuery] = useState('');
            const [aiResults, setAiResults] = useState([]);
            const [loadingAi, setLoadingAi] = useState(false);

            const handleSubmit = () => {
                if (!name) return;
                
                if (type === 'itinerary') {
                    const iconMap = { 'æ™¯é»': 'Spot', 'ç¾é£Ÿ': 'Food', 'è³¼ç‰©': 'Shopping' };
                    onConfirm({
                        name,
                        category,
                        time,
                        icon: iconMap[category] || 'Spot',
                        note: note
                    });
                } else {
                    onConfirm({
                        name,
                        amount: parseInt(amount) || 0,
                        type: 'food' 
                    });
                }
            };

            // Gemini: æœå°‹åœ°é»
            const handleAiSearch = async () => {
                if (!aiQuery) return;
                setLoadingAi(true);
                setAiResults([]);
                try {
                    const prompt = `User query: "${aiQuery}" in Kyoto/Osaka. Suggest 3 specific places. 
                    Return a strictly valid JSON array (no markdown code blocks) of objects with: 
                    name (string), 
                    category (one of: 'æ™¯é»', 'ç¾é£Ÿ', 'è³¼ç‰©'), 
                    note (short description under 10 words).`;
                    
                    const results = await callGemini(prompt, "You are a local Kyoto travel guide. Return pure JSON.");
                    if (Array.isArray(results)) {
                        setAiResults(results);
                    }
                } catch (e) {
                    console.error(e);
                    // è®“ç”¨æˆ¶çŸ¥é“å¤±æ•—äº†
                    setAiResults([{ name: "AI æœå°‹å¤±æ•—", category: "æ™¯é»", note: "è«‹æª¢æŸ¥ç¶²è·¯æˆ– API Key é™åˆ¶" }]);
                } finally {
                    setLoadingAi(false);
                }
            };

            const selectAiResult = (result) => {
                setName(result.name);
                setCategory(result.category);
                setNote(result.note);
                setShowAiSearch(false);
            };

            return (
                <div className="absolute inset-0 z-50 flex items-end">
                    <div className="absolute inset-0 bg-black/30 backdrop-blur-sm" onClick={onClose}></div>
                    <div className="bg-white w-full rounded-t-3xl p-6 relative z-10 animate-[slideUp_0.3s_ease-out] max-h-[90vh] overflow-y-auto">
                        <div className="w-12 h-1 bg-gray-200 rounded-full mx-auto mb-6"></div>
                        
                        <h3 className="text-xl font-bold mb-6 text-center flex items-center justify-center gap-2">
                            {type === 'itinerary' ? (showAiSearch ? 'âœ¨ AI æ™¯é»æ¢å‹˜' : 'æ–°å¢è¨±é¡˜åœ°é»') : 'è¨˜ä¸‹ä¸€ç­†'}
                        </h3>

                        <!-- AI æœå°‹æ¨¡å¼åˆ‡æ› (åƒ…é™è¡Œç¨‹) -->
                        {type === 'itinerary' && !showAiSearch && (
                            <button 
                                onClick={() => setShowAiSearch(true)}
                                className="w-full mb-6 bg-gradient-to-r from-indigo-500 to-purple-600 text-white p-3 rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg animate-sparkle"
                            >
                                <Icons.Magic /> âœ¨ AI å¹«æˆ‘æ‰¾éˆæ„Ÿ
                            </button>
                        )}

                        <div className="space-y-4 mb-8">
                            
                            <!-- AI æœå°‹ä»‹é¢ -->
                            {showAiSearch ? (
                                <div className="space-y-4">
                                    <div className="flex gap-2">
                                        <input 
                                            type="text" 
                                            value={aiQuery}
                                            onChange={(e) => setAiQuery(e.target.value)}
                                            placeholder="ä¾‹å¦‚ï¼šæ¸…æ°´å¯ºé™„è¿‘çš„æŠ¹èŒ¶ã€å®‰éœçš„ç¥ç¤¾..."
                                            className="flex-1 bg-gray-50 border border-purple-200 rounded-xl p-3 outline-none focus:border-purple-500"
                                            onKeyDown={(e) => e.key === 'Enter' && handleAiSearch()}
                                        />
                                        <button 
                                            onClick={handleAiSearch}
                                            disabled={loadingAi}
                                            className="bg-purple-600 text-white px-4 rounded-xl disabled:bg-gray-300"
                                        >
                                            {loadingAi ? <i className="fas fa-spinner fa-spin"></i> : <i className="fas fa-search"></i>}
                                        </button>
                                    </div>
                                    
                                    <div className="space-y-2">
                                        {aiResults.map((result, idx) => (
                                            <div 
                                                key={idx} 
                                                onClick={() => selectAiResult(result)}
                                                className="p-3 border border-gray-100 rounded-xl hover:bg-purple-50 hover:border-purple-200 cursor-pointer transition-colors flex justify-between items-center group"
                                            >
                                                <div>
                                                    <div className="font-bold text-gray-800">{result.name}</div>
                                                    <div className="text-xs text-gray-500">{result.category} â€¢ {result.note}</div>
                                                </div>
                                                <i className="fas fa-plus-circle text-gray-300 group-hover:text-purple-500"></i>
                                            </div>
                                        ))}
                                        {aiResults.length === 0 && !loadingAi && (
                                            <div className="text-center text-gray-400 text-sm py-4">
                                                è¼¸å…¥é—œéµå­—ï¼Œè®“ AI ç‚ºæ‚¨æ¨è–¦ç§æˆ¿æ™¯é»
                                            </div>
                                        )}
                                    </div>

                                    <button 
                                        onClick={() => setShowAiSearch(false)}
                                        className="w-full text-gray-400 text-sm py-2"
                                    >
                                        è¿”å›æ‰‹å‹•è¼¸å…¥
                                    </button>
                                </div>
                            ) : (
                                <!-- ä¸€èˆ¬è¼¸å…¥ä»‹é¢ -->
                                <>
                                    {type === 'itinerary' && (
                                        <div className="flex justify-center gap-4 mb-6">
                                            {['æ™¯é»', 'ç¾é£Ÿ', 'è³¼ç‰©'].map(cat => (
                                                <button 
                                                    key={cat}
                                                    onClick={() => setCategory(cat)}
                                                    className={`w-16 h-16 rounded-xl flex flex-col items-center justify-center gap-1 border-2 transition-all ${
                                                        category === cat 
                                                        ? 'border-kyoto-gold bg-kyoto-gold/10 text-kyoto-gold' 
                                                        : 'border-gray-100 text-gray-400'
                                                    }`}
                                                >
                                                    <i className={`fas ${cat === 'æ™¯é»' ? 'fa-camera' : cat === 'ç¾é£Ÿ' ? 'fa-utensils' : 'fa-shopping-bag'}`}></i>
                                                    <span className="text-xs">{cat}</span>
                                                </button>
                                            ))}
                                        </div>
                                    )}

                                    <div>
                                        <label className="text-xs font-bold text-gray-400 block mb-1">åç¨±</label>
                                        <input 
                                            type="text" 
                                            value={name}
                                            onChange={(e) => setName(e.target.value)}
                                            placeholder={type === 'itinerary' ? "ä¾‹å¦‚: æ¸…æ°´å¯º" : "ä¾‹å¦‚: ç« é­šç‡’"}
                                            className="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 outline-none focus:border-kyoto-gold"
                                            autoFocus={!showAiSearch}
                                        />
                                    </div>

                                    {type === 'itinerary' ? (
                                        <div className="flex gap-3">
                                            <div className="flex-1">
                                                <label className="text-xs font-bold text-gray-400 block mb-1">é è¨ˆæ™‚é–“</label>
                                                <input 
                                                    type="time" 
                                                    value={time}
                                                    onChange={(e) => setTime(e.target.value)}
                                                    className="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 outline-none focus:border-kyoto-gold"
                                                />
                                            </div>
                                            <div className="flex-[2]">
                                                <label className="text-xs font-bold text-gray-400 block mb-1">å‚™è¨»</label>
                                                <input 
                                                    type="text" 
                                                    value={note}
                                                    onChange={(e) => setNote(e.target.value)}
                                                    className="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 outline-none focus:border-kyoto-gold"
                                                />
                                            </div>
                                        </div>
                                    ) : (
                                        <div>
                                            <label className="text-xs font-bold text-gray-400 block mb-1">é‡‘é¡ (Â¥)</label>
                                            <input 
                                                type="number" 
                                                value={amount}
                                                onChange={(e) => setAmount(e.target.value)}
                                                placeholder="0"
                                                className="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 outline-none focus:border-kyoto-gold font-mono"
                                            />
                                        </div>
                                    )}
                                </>
                            )}
                        </div>

                        {!showAiSearch && (
                            <div className="flex gap-3">
                                <button onClick={onClose} className="flex-1 py-3 rounded-xl bg-gray-100 font-bold text-gray-500">å–æ¶ˆ</button>
                                <button onClick={handleSubmit} className="flex-1 py-3 rounded-xl bg-kyoto-gold text-white font-bold shadow-lg shadow-yellow-200">
                                    åŠ å…¥æ¸…å–®
                                </button>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        function TabButton({ icon, label, active, onClick }) {
            const IconComp = Icons[icon];
            return (
                <button onClick={onClick} className="flex flex-col items-center justify-center w-16 transition-colors">
                    <div className={`text-xl mb-1 ${active ? 'text-kyoto-gold' : 'text-gray-300'}`}>
                        <IconComp />
                    </div>
                    <span className={`text-[10px] font-bold ${active ? 'text-gray-800' : 'text-gray-300'}`}>
                        {label}
                    </span>
                </button>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
